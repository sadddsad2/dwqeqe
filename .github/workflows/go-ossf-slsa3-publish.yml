name: Build AppProxy ECH

on:
  push:
    branches: [ main, iyue ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, iyue ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.19.0'
  JAVA_VERSION: '17'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        ref: main
    
    - name: ğŸ”§ è®¾ç½® Java ç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'gradle'
    
    - name: ğŸ¯ è®¾ç½® Flutter ç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: ğŸ› ï¸ è¿è¡Œ one.sh ç”Ÿæˆé¡¹ç›®ç»“æ„
      run: |
        chmod +x one.sh
        
        # è¾“å…¥é€‰é¡¹ï¼š2 = ä»…åˆ›å»ºé¡¹ç›®ç»“æ„ï¼Œ0 = é€€å‡º
        printf "2\n0\n" | ./one.sh || true
        
        echo "ç”Ÿæˆçš„ç›®å½•ç»“æ„:"
        ls -la
    
    - name: ğŸ“ åˆ›å»º pubspec.yaml (å¦‚æœä¸å­˜åœ¨)
      run: |
        if [ ! -f "pubspec.yaml" ]; then
          echo "åˆ›å»º pubspec.yaml..."
          cat > pubspec.yaml << 'EOF'
name: appproxy_ech
description: AppProxy ECH Client - Encrypted Client Hello proxy client
version: 1.0.0+1

environment:
  sdk: '>=3.0.0 <4.0.0'

dependencies:
  flutter:
    sdk: flutter
  cupertino_icons: ^1.0.2
  shared_preferences: ^2.2.2
  flutter_native_splash: ^2.3.8

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^3.0.0

flutter:
  uses-material-design: true
EOF
          echo "âœ… pubspec.yaml å·²åˆ›å»º"
        else
          echo "âœ… pubspec.yaml å·²å­˜åœ¨"
        fi
        
        cat pubspec.yaml
    
    - name: ğŸ“ åˆ›å»º main.dart (å¦‚æœä¸å­˜åœ¨)
      run: |
        mkdir -p lib
        
        if [ ! -f "lib/main.dart" ]; then
          echo "åˆ›å»º lib/main.dart..."
          cat > lib/main.dart << 'EOF'
import 'package:flutter/material.dart';

void main() {
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'AppProxy ECH',
      theme: ThemeData(
        colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),
        useMaterial3: true,
      ),
      home: const MyHomePage(title: 'AppProxy ECH Client'),
    );
  }
}

class MyHomePage extends StatefulWidget {
  const MyHomePage({super.key, required this.title});

  final String title;

  @override
  State<MyHomePage> createState() => _MyHomePageState();
}

class _MyHomePageState extends State<MyHomePage> {
  bool _isRunning = false;

  void _toggleProxy() {
    setState(() {
      _isRunning = !_isRunning;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        backgroundColor: Theme.of(context).colorScheme.inversePrimary,
        title: Text(widget.title),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: <Widget>[
            Icon(
              _isRunning ? Icons.check_circle : Icons.cancel,
              size: 100,
              color: _isRunning ? Colors.green : Colors.grey,
            ),
            const SizedBox(height: 20),
            Text(
              _isRunning ? 'Proxy Running' : 'Proxy Stopped',
              style: Theme.of(context).textTheme.headlineMedium,
            ),
            const SizedBox(height: 40),
            ElevatedButton(
              onPressed: _toggleProxy,
              style: ElevatedButton.styleFrom(
                padding: const EdgeInsets.symmetric(horizontal: 40, vertical: 15),
              ),
              child: Text(_isRunning ? 'Stop' : 'Start'),
            ),
          ],
        ),
      ),
    );
  }
}
EOF
          echo "âœ… lib/main.dart å·²åˆ›å»º"
        else
          echo "âœ… lib/main.dart å·²å­˜åœ¨"
        fi
    
    - name: ğŸ“¦ å‡†å¤‡ AAR æ–‡ä»¶
      run: |
        # åˆ›å»º libs ç›®å½•
        mkdir -p android/app/libs
        
        # å¤åˆ¶æ ¹ç›®å½•çš„é¢„ç¼–è¯‘ AAR
        if [ -f "proxyclient.aar" ]; then
          cp proxyclient.aar android/app/libs/proxyclient.aar
          echo "âœ… AAR æ–‡ä»¶å·²ä»æ ¹ç›®å½•å¤åˆ¶"
          ls -lh android/app/libs/proxyclient.aar
        else
          echo "âŒ æ ¹ç›®å½•æ‰¾ä¸åˆ° proxyclient.aar"
          ls -la
          exit 1
        fi
    
    - name: ğŸ”§ é…ç½® Android build.gradle
      run: |
        # ç¡®ä¿ android/app/build.gradle å­˜åœ¨å¹¶é…ç½®äº† AAR
        if [ -f "android/app/build.gradle" ]; then
          echo "âœ… android/app/build.gradle å·²å­˜åœ¨"
          
          # æ£€æŸ¥æ˜¯å¦å·²é…ç½® flatDir
          if ! grep -q "flatDir" android/app/build.gradle; then
            echo "æ·»åŠ  flatDir é…ç½®..."
            # è¿™é‡Œå¯ä»¥æ·»åŠ ä¿®æ”¹ build.gradle çš„é€»è¾‘
          fi
        else
          echo "âš ï¸ android/app/build.gradle ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
        fi
    
    - name: ğŸ“± è·å– Flutter ä¾èµ–
      run: |
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo ""
        echo "pubspec.yaml å†…å®¹:"
        cat pubspec.yaml
        echo ""
        
        flutter pub get
        
        echo ""
        echo "âœ… Flutter ä¾èµ–å®‰è£…å®Œæˆ"
    
    - name: ğŸ—ï¸ æ„å»º APK (Debug)
      if: github.ref != 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
      run: |
        flutter build apk --debug
        mv build/app/outputs/flutter-apk/app-debug.apk \
           build/app/outputs/flutter-apk/appproxy-ech-debug.apk
    
    - name: ğŸ—ï¸ æ„å»º APK (Release)
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
      run: |
        flutter build apk --release
        mv build/app/outputs/flutter-apk/app-release.apk \
           build/app/outputs/flutter-apk/appproxy-ech-release.apk
    
    - name: ğŸ“Š ç”Ÿæˆæ„å»ºä¿¡æ¯
      run: |
        echo "Build Date: $(date)" > build_info.txt
        echo "Git Commit: ${{ github.sha }}" >> build_info.txt
        echo "Git Branch: ${{ github.ref_name }}" >> build_info.txt
        echo "Flutter Version: $(flutter --version | head -n 1)" >> build_info.txt
        echo "AAR File: $(ls -lh android/app/libs/proxyclient.aar 2>/dev/null || echo 'N/A')" >> build_info.txt
        cat build_info.txt
    
    - name: ğŸ“¤ ä¸Šä¼  Debug APK
      if: github.ref != 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: appproxy-ech-debug
        path: |
          build/app/outputs/flutter-apk/appproxy-ech-debug.apk
          build_info.txt
        retention-days: 7
    
    - name: ğŸ“¤ ä¸Šä¼  Release APK
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: appproxy-ech-release
        path: |
          build/app/outputs/flutter-apk/appproxy-ech-release.apk
          build_info.txt
        retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: appproxy-ech-release
        path: ./release
    
    - name: ğŸ‰ åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./release/appproxy-ech-release.apk
          ./release/build_info.txt
        body: |
          ## AppProxy ECH å®¢æˆ·ç«¯ ${{ github.ref_name }}
          
          ### æ–°åŠŸèƒ½
          - âœ… ECH (Encrypted Client Hello) æ”¯æŒ
          - âœ… WebSocket æŒä¹…è¿æ¥
          - âœ… SOCKS5 / HTTP ä»£ç†
          - âœ… DNS over HTTPS
          
          ### ä¸‹è½½
          `appproxy-ech-release.apk` - é€šç”¨ç‰ˆæœ¬
          
          ### æ„å»ºä¿¡æ¯
          æŸ¥çœ‹ build_info.txt äº†è§£è¯¦ç»†ä¿¡æ¯
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
