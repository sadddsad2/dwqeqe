name: Build AppProxy ECH

on:
  push:
    branches: [ main, iyue ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, iyue ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.19.0'
  JAVA_VERSION: '17'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        ref: main
    
    - name: ğŸ”§ è®¾ç½® Java ç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'gradle'
    
    - name: ğŸ¯ è®¾ç½® Flutter ç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: ğŸ› ï¸ è¿è¡Œ one.sh ç”Ÿæˆé¡¹ç›®æ–‡ä»¶ï¼ˆè·³è¿‡ Go æ„å»ºï¼‰
      run: |
        chmod +x one.sh
        
        # æ£€æŸ¥è„šæœ¬å†…å®¹ï¼Œçœ‹çœ‹é€‰é¡¹ 2 æ˜¯åšä»€ä¹ˆçš„
        echo "æ‰§è¡Œ one.sh é€‰é¡¹ 2ï¼ˆåˆ›å»ºé¡¹ç›®ç»“æ„ï¼‰"
        
        # è¾“å…¥é€‰é¡¹ï¼š2 = ä»…åˆ›å»ºé¡¹ç›®ç»“æ„ï¼Œ0 = é€€å‡º
        printf "2\n0\n" | ./one.sh || {
          echo "âš ï¸ one.sh æ‰§è¡Œé‡åˆ°é—®é¢˜ï¼Œä½†ç»§ç»­è¿›è¡Œ"
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la
        }
        
        # éªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
        echo ""
        echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶:"
        [ -f "pubspec.yaml" ] && echo "âœ… pubspec.yaml" || echo "âŒ pubspec.yaml ç¼ºå¤±"
        [ -d "lib" ] && echo "âœ… lib/" || echo "âŒ lib/ ç¼ºå¤±"
        [ -d "android" ] && echo "âœ… android/" || echo "âŒ android/ ç¼ºå¤±"
    
    - name: ğŸ“¦ å‡†å¤‡ AAR æ–‡ä»¶
      run: |
        # åˆ›å»º libs ç›®å½•
        mkdir -p android/app/libs
        
        # å¤åˆ¶æ ¹ç›®å½•çš„é¢„ç¼–è¯‘ AAR
        if [ -f "proxyclient.aar" ]; then
          cp proxyclient.aar android/app/libs/proxyclient.aar
          echo "âœ… AAR æ–‡ä»¶å·²ä»æ ¹ç›®å½•å¤åˆ¶"
          ls -lh android/app/libs/proxyclient.aar
        else
          echo "âŒ æ ¹ç›®å½•æ‰¾ä¸åˆ° proxyclient.aar"
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          exit 1
        fi
    
    - name: ğŸ“± è·å– Flutter ä¾èµ–
      run: |
        echo "å½“å‰ç›®å½•: $(pwd)"
        
        # æ£€æŸ¥ pubspec.yaml
        if [ ! -f "pubspec.yaml" ]; then
          echo "âŒ æ‰¾ä¸åˆ° pubspec.yaml"
          echo "ç›®å½•å†…å®¹:"
          ls -la
          exit 1
        fi
        
        echo "pubspec.yaml å†…å®¹é¢„è§ˆ:"
        head -20 pubspec.yaml
        
        flutter pub get
    
    - name: ğŸ—ï¸ æ„å»º APK (Debug)
      if: github.ref != 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
      run: |
        flutter build apk --debug
        mv build/app/outputs/flutter-apk/app-debug.apk \
           build/app/outputs/flutter-apk/appproxy-ech-debug.apk
    
    - name: ğŸ—ï¸ æ„å»º APK (Release)
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
      run: |
        flutter build apk --release
        mv build/app/outputs/flutter-apk/app-release.apk \
           build/app/outputs/flutter-apk/appproxy-ech-release.apk
    
    - name: ğŸ“Š ç”Ÿæˆæ„å»ºä¿¡æ¯
      run: |
        echo "Build Date: $(date)" > build_info.txt
        echo "Git Commit: ${{ github.sha }}" >> build_info.txt
        echo "Git Branch: ${{ github.ref_name }}" >> build_info.txt
        echo "Flutter Version: $(flutter --version | head -n 1)" >> build_info.txt
        echo "AAR File: $(ls -lh android/app/libs/proxyclient.aar 2>/dev/null || echo 'N/A')" >> build_info.txt
        cat build_info.txt
    
    - name: ğŸ“¤ ä¸Šä¼  Debug APK
      if: github.ref != 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: appproxy-ech-debug
        path: |
          build/app/outputs/flutter-apk/appproxy-ech-debug.apk
          build_info.txt
        retention-days: 7
    
    - name: ğŸ“¤ ä¸Šä¼  Release APK
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: appproxy-ech-release
        path: |
          build/app/outputs/flutter-apk/appproxy-ech-release.apk
          build_info.txt
        retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: appproxy-ech-release
        path: ./release
    
    - name: ğŸ‰ åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./release/appproxy-ech-release.apk
          ./release/build_info.txt
        body: |
          ## AppProxy ECH å®¢æˆ·ç«¯ ${{ github.ref_name }}
          
          ### æ–°åŠŸèƒ½
          - âœ… ECH (Encrypted Client Hello) æ”¯æŒ
          - âœ… WebSocket æŒä¹…è¿æ¥
          - âœ… SOCKS5 / HTTP ä»£ç†
          - âœ… DNS over HTTPS
          
          ### ä¸‹è½½
          `appproxy-ech-release.apk` - é€šç”¨ç‰ˆæœ¬
          
          ### æ„å»ºä¿¡æ¯
          æŸ¥çœ‹ build_info.txt äº†è§£è¯¦ç»†ä¿¡æ¯
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
